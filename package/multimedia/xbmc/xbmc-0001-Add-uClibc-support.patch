From 0b337bab2620e86053d8256be0c33b078d8d1d14 Mon Sep 17 00:00:00 2001
From: octo <octo@lusca.local>
Date: Wed, 12 Dec 2012 21:35:25 +0100
Subject: [PATCH] Add uClibc support

Add support for uClibc toolchain.
Patch originally taken from :
http://repository.timesys.com/buildsources/x/xbmc/xbmc-11.0/xbmc-11.0-fixups.patch

---
 configure.in                                       |   10 +++++-----
 xbmc/cores/DllLoader/exports/emu_msvcrt.h          |    6 +++---
 xbmc/cores/DllLoader/exports/util/EmuFileWrapper.h |    4 +++-
 3 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/configure.in b/configure.in
index 23312bd..c49edc9 100644
--- a/configure.in
+++ b/configure.in
@@ -558,11 +558,11 @@ case $host in
      use_cpu="i686"
      ffmpeg_target_os=linux
      ;;
-  i*86*-linux-gnu*)
+  i*86*-linux-gnu* | i*86*-linux-uclibc*)
      ARCH="i486-linux"
      AC_SUBST(ARCH_DEFINES, "-DTARGET_POSIX -DTARGET_LINUX -D_LINUX")
      ;;
-  x86_64-*-linux-gnu*)
+  x86_64-*-linux-gnu* | x86_64-*-linux-uclibc*)
      ARCH="x86_64-linux"
      AC_SUBST(ARCH_DEFINES, "-DTARGET_POSIX -DTARGET_LINUX -D_LINUX")
      ;;
@@ -613,15 +613,15 @@ case $host in
      use_arch="ppc"
      AC_SUBST(ARCH_DEFINES, "-DTARGET_POSIX -DTARGET_DARWIN -DTARGET_DARWIN_OSX -D_LINUX")
      ;;
-  powerpc-*-linux-gnu*)
+  powerpc-*-linux-gnu* | powerpc-*-linux-uclibc*)
      ARCH="powerpc-linux"
      AC_SUBST(ARCH_DEFINES, "-DTARGET_POSIX -DTARGET_LINUX -D_LINUX -D_POWERPC")
      ;;
-  powerpc64-*-linux-gnu*)
+  powerpc64-*-linux-gnu* | powerpc64-*-linux-uclibc*)
      ARCH="powerpc64-linux"
      AC_SUBST(ARCH_DEFINES, "-DTARGET_POSIX -DTARGET_LINUX -D_LINUX -D_POWERPC64")
      ;;
-  arm*-*-linux-gnu*)
+  arm*-*-linux-gnu* | arm*-*-linux-uclibc*)
      use_texturepacker=no
      ARCH="arm"
      use_arch="arm"
diff --git a/xbmc/cores/DllLoader/exports/emu_msvcrt.h b/xbmc/cores/DllLoader/exports/emu_msvcrt.h
index d88c360..4bb5a4b 100644
--- a/xbmc/cores/DllLoader/exports/emu_msvcrt.h
+++ b/xbmc/cores/DllLoader/exports/emu_msvcrt.h
@@ -46,9 +46,9 @@ typedef fpos_t   fpos64_t; // no 64-bit on android
 
 typedef void ( *PFV)(void);
 
-#define __IS_STDIN_STREAM(stream)   (stream == stdin  || stream->_file == stdin->_file || stream->_file == 0)
-#define __IS_STDOUT_STREAM(stream)  (stream == stdout || stream->_file == stdout->_file || stream->_file == 1)
-#define __IS_STDERR_STREAM(stream)  (stream == stderr || stream->_file == stderr->_file || stream->_file == 2)
+#define __IS_STDIN_STREAM(stream)   (stream == stdin  || fileno(stream) == fileno(stdin) || fileno(stream) == 0)
+#define __IS_STDOUT_STREAM(stream)  (stream == stdout || fileno(stream) == fileno(stdout) || fileno(stream) == 1)
+#define __IS_STDERR_STREAM(stream)  (stream == stderr || fileno(stream) == fileno(stderr) || fileno(stream) == 2)
 #define IS_STDIN_STREAM(stream)     (stream != NULL && __IS_STDIN_STREAM(stream))
 #define IS_STDOUT_STREAM(stream)    (stream != NULL && __IS_STDOUT_STREAM(stream))
 #define IS_STDERR_STREAM(stream)    (stream != NULL && __IS_STDERR_STREAM(stream))
diff --git a/xbmc/cores/DllLoader/exports/util/EmuFileWrapper.h b/xbmc/cores/DllLoader/exports/util/EmuFileWrapper.h
index 607c7db..5124920 100644
--- a/xbmc/cores/DllLoader/exports/util/EmuFileWrapper.h
+++ b/xbmc/cores/DllLoader/exports/util/EmuFileWrapper.h
@@ -27,8 +27,10 @@
 #include "system.h"
 #include "threads/CriticalSection.h"
 
-#if defined(_LINUX) && !defined(TARGET_DARWIN) && !defined(__FreeBSD__) && !defined(__ANDROID__)
+#if defined(_LINUX) && !defined(TARGET_DARWIN) && !defined(__FreeBSD__) && !defined(__ANDROID__) && !defined(__UCLIBC__)
 #define _file _fileno
+#elif defined(__UCLIBC__)
+#define _file __filedes
 #endif
 
 #define MAX_EMULATED_FILES    50
-- 
1.7.10.4

